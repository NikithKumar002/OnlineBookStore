# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

variables:
  containerRegistry: 'ThreeTierApplication_ServiceConnection'
  imageName:: 'nodeJS-App'
  imageTag: $(Build.BuildId)
  System.Debug: true

pool:
  name: SelfHostedLinuxVM
  demands:
    agent -equals AzurePipelineVM

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js'

- script: |
    ls
    pwd
    cd server
    npm install
  timeoutInMinutes: 300
  displayName: 'npm install the dependencies'

- script: |
    npm run test
  displayName: 'npm test'

- task: Docker@2
  inputs:
    containerRegistry: 'ThreeTierApplication_ServiceConnection'
    repository: '$(branch)/$(imageName)'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: |
      $(imageTag)
  displayName: "Build and push Image container Registry"